{% extends 'base.html' %} 
{% load url from future %} 
{% load extra_tags %} 
{% load django_bootstrap_breadcrumbs %} 

{% block headextra %}

<script src="{{ STATIC_URL}}js/vendor/threadpool.js"></script>

<link rel="stylesheet" href="{{ STATIC_URL}}css/database_info.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/jquery.boolrelwidget.css"></script>

<!-- Generic page styles -->
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/style.css">
<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/jquery.fileupload-ui.css">
<link href="{{ STATIC_URL }}nvd3/src/nv.d3.css" rel="stylesheet" type="text/css">
<!--
<script src="{{ STATIC_URL }}nvd3/lib/d3.v3.js"></script>
<script src="{{ STATIC_URL }}nvd3/nv.d3.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/axis.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/historicalBar.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/historicalBarChart.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/utils.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/axis.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/discreteBar.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/discreteBarChart.js"></script>

-->


<script src="{{ STATIC_URL}}js/emif.documents.js"></script>


<script src="{{ STATIC_URL}}js/emif.jerboa.upload.js"></script>

<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<script src="{{ STATIC_URL }}js/vendor/jquery.ui.widget.js"></script>
<!-- The Load Image plugin is included for the preview images and image resizing functionality -->
<script src="{{ STATIC_URL }}js/vendor/load-image.min.js"></script>
<!-- The Canvas to Blob plugin is included for image resizing functionality -->
<script src="{{ STATIC_URL }}js/vendor/canvas-to-blob.min.js"></script>

<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="{{ STATIC_URL }}js/vendor/jquery.iframe-transport.js"></script>
<!-- The basic File Upload plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload.js"></script>
<!-- The File Upload processing plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-process.js"></script>
<!-- The File Upload image preview & resize plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-image.js"></script>
<!-- The File Upload audio preview plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-audio.js"></script>
<!-- The File Upload video preview plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-video.js"></script>
<!-- The File Upload validation plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-validate.js"></script>
<script src="{{ STATIC_URL }}js/vendor/jquery.cookie.js"></script>
<script src="{{ STATIC_URL}}js/vendor/jquery.boolrelwidget.js"></script>

{% endblock %} 
{% block breadcrumbs %} 
{{ block.super }} 
    {% if search_old %}
        {% breadcrumb "Search" "resultsdiff/1" %} 
        {% breadcrumb breadcrumb_name "databases" %} 
    {% elif style == '1' %} 
        {% breadcrumb "My Databases" "databases" %} 
        {% breadcrumb breadcrumb_name "databases" %} 
    {% else %} 
        {% breadcrumb "All Databases" "alldatabases" %} 
        {% breadcrumb breadcrumb_name "databases" %} 
    {% endif %}

{% endblock %}

{% block toolbar %} 
    {% include "menu_toolbar.html" with collapse=collapseall %} 
{% endblock %} 

{% block content %} 
{% if qsets %}

<div class="span12">
    <div class="row-fluid">
        <div class="tabbable">
            <ul class="nav nav-tabs">
                <li class="{%if activetab == 'summary'%}active{%endif%}">
                    <a href="#metadata" data-toggle="tab">Fingerprint</a>
                </li>
                <li class="{%if activetab == 'pc'%}active{%endif%}">
                    <a href="#populationcharacteristics" data-toggle="tab">Population Characteristics</a>
                </li>
                <li  class="{%if activetab == 'docs'%}active{%endif%}">
                    <a href="#documents" data-toggle="tab">Documents</a>
                </li>
                <!--
                <li  class="{%if activetab == 'literature'%}active{%endif%}">
                    <a href="#literature" data-toggle="tab">Literature</a>
                </li>
                -->
                
                <li  class="{%if activetab == 'extra'%}active{%endif%}">
                    <a href="#apiinfo" data-toggle="tab">Extra Information</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane {%if activetab == 'summary'%}active{%endif%}" id="metadata">
                    <div>
                        <a id="collapseall_metadata" class="btn pull-right" href="">Expand all</a>
                    </div>
                    <div class="accordion fullwidth pull-left " id="accordion1" style="margin-top: 10px;">
                        <div id="set_container"></div>
                    </div>

                </div>


                <div class="tab-pane {%if activetab == 'pc'%}active{%endif%}" id="populationcharacteristics" >

                  {% include "population_characteristics.html" %}

                </div>

              <div class="tab-pane {%if activetab == 'docs'%}active{%endif%}" id="documents">
                
                    {% include "documents.html" %}
            </div>



                <div class="tab-pane {%if activetab == 'literature'%}active{%endif%}" id="literature">
                    <div>
                        <a id="collapseall_literature" class="btn pull-right" href="">Expand all</a>
                    </div>
                    <div class="accordion pull-left " id="accordion2" style="margin-top: 10px;">
                        <div class="accordion-group">
                            <div class="accordion-heading">
                                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                                    Upregulation of chemokines and their receptors in Duchenne muscular dystrophy: potential for attenuation of myofiber necrosis.
                                </a>
                            </div>
                            <div id="collapseOne" class="accordion-body collapse in">
                                <div class="accordion-inner">
                                    <div id="becas-widget-text" class="widget-container"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-group">
                            <div class="accordion-heading">
                                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseTwo">
                                    Upregulation of chemokines and their receptors in Duchenne muscular dystrophy: potential for attenuation of myofiber necrosis.
                                </a>
                            </div>
                            <div id="collapseTwo" class="accordion-body collapse">
                                <div class="accordion-inner">
                                    <!-- Container to hold another widget -->
                                    <div id="becas-widget-pmid" class="widget-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="tab-pane {%if activetab == 'extra'%}active{%endif%}" id="apiinfo">
                    <div>
                        <a id="btn_pivot_table" class="btn pull-right hidden" href="">Pivot table</a>
                    </div>
                    <div class="">
                        <div id="chart" class="span4" style="display:none;"></div>

                        <div  class='span9' id="pivot_table_extra_information">

                        </div>

                    </div>
                    <div class="span8"></div>
                </div>

            </div>
            
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="span4">
            <div class="alert">
                <a class="close" data-dismiss="error">Ã—</a>
                <strong>Warning!</strong>
                You don't have results.
            </div>
        </div>
    </div>
</div>
    {% endif %}

<!-- Display a message to users with Javascript deactivated -->
<noscript>
    <div style="position:absolute;top:0;left:0;width:500px;height:250px;border:2px solid #A00;padding:6px;background-color:#fff;color:#600;text-align:center">
        <h1>This page requires Javascript to function properly.</h1>

        <h2>Please follow this instructions on how to
            <a href="http://www.enable-javascript.com/" target="_blank">enable JavaScript in your web browser</a>.</h2>
    </div>
</noscript>
{% if isAdvanced %}
<div id="bool_container"></div>
{% endif %}

{% endblock %} 

{% block scriptextraincludes %}
<!-- Include the widget embedding script -->
<script src="//bioinformatics.ua.pt/becas/embed-widget.js"></script>
<script src="{{ STATIC_URL}}js/database_info.js"></script>

<!--[if lte IE 8]><script src="{{ STATIC_URL}}js/d3/r2d3.min.js" charset="utf-8"></script><![endif]-->
<!--[if gte IE 9]><!-->
    <script src="{{ STATIC_URL}}js/d3/d3.v3.min.js"></script>
    <script src="{{ STATIC_URL}}js/d3/d3.layout.cloud.js"></script>
<!--<![endif]-->
<script src="{{ STATIC_URL }}js/emif.database.delete.js"></script>

<script src="{{ STATIC_URL}}js/emif.populationcharacteristics.charts.js"></script>

<script src="{{ STATIC_URL}}js/emif.populationcharacteristics.js"></script>



{% endblock %}

{% block scriptextra %}
var threads = {};
function load_questionnary(){

        console.log("Creating questionnary set containers (so they are in order)");
        
        var containers = [];

        // We build the qs containers in memory and just do dom op, on the end, for speed
        // on ie joins are significantly faster than concatenation
        {% for k, qs in qsets.ordered_items %}
            containers.push('<div class="accordion-group"><div class="accordion-heading"><a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion1" href="#collapse{{ k|removespaces|safe|clean }}">{{ k|removeh1 }}</a></div><div id="collapse{{ k|removespaces|safe|clean }}" class="accordion-body collapse"><div id="qs_{{ qs.sortid }}" class="accordion-inner"><h4 class="pull-center">Loading...</h4></div></div></div>');
        
        {% endfor %}

        $('#set_container').append(containers.join(''));

        console.log( "Loading questionnary by parts, we have {{qsets|length}} sets");  
        
        var threadpool = new ThreadPool(1);
        parts_missing = {{qsets|length}};
        

        // i dont everything on a single run, because i just add the containers all at once, not by parts
        // only the constainers content are loaded by parts

        var priority=1;
        {% for k, qs in qsets.ordered_items %}
            var thread = new Runnable(loadqspart, priority++, {{qs.sortid}}, '{{fingerprint_id}}');

            threadpool.run(thread);
            threads['qs_{{ qs.sortid }}'] = thread;
        {% endfor %}

        //  we add the triggers thread
        threadpool.destroy();
}
function loadqspart(sortid, pk){
    $.get( "fingerprintqs/"+pk+"/"+sortid+"/", function( data ) {
      $( "#qs_"+sortid ).html( data );
    });    
    threads['qs_'+sortid] = null;
    parts_missing--;
    this.complete();
}
<!-- This must be here because of dynamic code -->
$(document).ready(function() {
    load_questionnary();
    // On expand event, we burst the priority of this thread to load before the others
    $('.accordion-heading').click(function(){
        var load_faster = $('.accordion-inner', $(this).parent()).attr('id');
        console.log("Thread state for "+load_faster+": "+threads[load_faster]);        
        if(threads[load_faster] != null){
            threads[load_faster].setPriority(0);
        }        
    });

    var json_aux = '{{apiinfo}}';
console.log("ayx" + json_aux.length);
console.log("ayx" + json_aux);
    
    if (json_aux == '' || json_aux == null || json_aux.length == 2) {
        $("#pivot_table_extra_information").html('No information available. You can add information from external applications with <a href="api-info">API web services.</a>');
    } else {
        $("#btn_pivot_table").removeClass("hidden");
        $("#btn_pivot_table").addClass("show");
        json_aux = json_aux.replace("/&quot;/g", "\"");
        alert(json_aux);
        json = JSON.parse(json_aux);
        //console.log(json_aux);
        //console.log(json);
        var json2 = json;
        json = json_to_d3json(json);
        json.x0 = 0;
        json.y0 = 0;
    
        update(root = json);
        $("#pivot_table_extra_information").html(json_to_table(json2));
    }
});
 {% if isAdvanced %}
 var bool_container;
$(function(){
    bool_container = $('#bool_container').boolrelwidget({view_only: true, view_serialized_string: '{{request.session.serialization_query}}', link_back: $('#base_link').prop('href')+"advancedSearch/{{request.session.query_type}}/1/{{request.session.query_id}}"});
});
  {% endif %}

{% endblock %}

