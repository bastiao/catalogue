{% extends 'base.html' %} 
{% load url from future %} 
{% load extra_tags %} 
{% load django_bootstrap_breadcrumbs %} 
{% load comments %}

{% block headextra %}

<script src="{{ STATIC_URL}}js/vendor/threadpool.js"></script>

<script src="{{ STATIC_URL}}js/vendor/jquery.expander.min.js"></script>


<link rel="stylesheet" href="{{ STATIC_URL}}css/database_info.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/jquery.boolrelwidget.css"></script>

<!-- Generic page styles -->
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/style.css">
<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/jquery.fileupload-ui.css">

<!--
<link href="{{ STATIC_URL }}nvd3/src/nv.d3.css" rel="stylesheet" type="text/css">
<script src="{{ STATIC_URL }}nvd3/lib/d3.v3.js"></script>
<script src="{{ STATIC_URL }}nvd3/nv.d3.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/axis.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/historicalBar.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/historicalBarChart.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/utils.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/axis.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/discreteBar.js"></script>
<script src="{{ STATIC_URL }}nvd3/src/models/discreteBarChart.js"></script>

-->

<link rel="stylesheet" href="{{ STATIC_URL }}css/c3.css">

<script src="{{ STATIC_URL}}js/emif.documents.js"></script>

<script src="{{ STATIC_URL}}js/emif.jerboa.upload.js"></script>

<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<script src="{{ STATIC_URL }}js/vendor/jquery.ui.widget.js"></script>
<!-- The Load Image plugin is included for the preview images and image resizing functionality -->
<script src="{{ STATIC_URL }}js/vendor/load-image.min.js"></script>
<!-- The Canvas to Blob plugin is included for image resizing functionality -->
<script src="{{ STATIC_URL }}js/vendor/canvas-to-blob.min.js"></script>

<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="{{ STATIC_URL }}js/vendor/jquery.iframe-transport.js"></script>
<!-- The basic File Upload plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload.js"></script>
<!-- The File Upload processing plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-process.js"></script>
<!-- The File Upload image preview & resize plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-image.js"></script>
<!-- The File Upload audio preview plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-audio.js"></script>
<!-- The File Upload video preview plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-video.js"></script>
<!-- The File Upload validation plugin -->
<script src="{{ STATIC_URL }}js/vendor/jquery.fileupload-validate.js"></script>
<script src="{{ STATIC_URL }}js/vendor/jquery.cookie.js"></script>
<script src="{{ STATIC_URL}}js/vendor/jquery.boolrelwidget.js"></script>

{% endblock %} 
{% block breadcrumbs %} 
{{ block.super }} 
{% if search_old %}
{% breadcrumb "Search" "resultsdiff/1" %} 
{% breadcrumb breadcrumb_name "databases" %} 
{% elif style == '1' %} 
{% breadcrumb "Personal" "databases" %} 
{% breadcrumb breadcrumb_name|ellipsis:40 "databases" %} 
{% else %} 
{% breadcrumb "All" "alldatabases" %} 
{% breadcrumb breadcrumb_name|ellipsis:40 "databases" %} 
{% endif %}

{% endblock %}

{% block toolbar %} 
{% include "menu_toolbar.html" with collapse=collapseall %} 
{% endblock %} 

{% block content %} 
{% if qsets %}

<div style="margin-left: 0px;" class="span12">
    <div class="row-fluid">
        <div class="tabbable">
            <ul class="nav nav-tabs">
                <li class="{%if activetab == 'summary'%}active{%endif%}">
                    <a href="#metadata" data-toggle="tab"><i class="icon-list"></i>&nbsp; Fingerprint</a>
                </li>
                <li class="{%if activetab == 'pc'%}active{%endif%}">
                    <a href="#populationcharacteristics" data-toggle="tab"><i class="icon-signal"></i>&nbsp; Population Characteristics</a>
                </li>
                <li  class="{%if activetab == 'docs'%}active{%endif%}">
                    <a href="#documents" data-toggle="tab"><i class="icon-folder-close"></i>&nbsp; Documents</a>
                </li>
                
                <li class="{%if activetab == 'literature'%}active{%endif%}">
                    <a href="#literature" data-toggle="tab"><i class="icon-book"></i>&nbsp; Literature</a>
                </li>
                
                <li  class="{%if activetab == 'extra'%}active{%endif%}">
                    <a href="#apiinfo" data-toggle="tab"><i class="icon-download-alt"></i> &nbsp; Extra Information</a>
                </li>

                <li  class="{%if activetab == 'discussion'%}active{%endif%}">
                    <a href="#discussion" data-toggle="tab"><i class="fa fa-comment"></i> &nbsp; Discussion</a>
            </ul>
            <div style="margin-bottom: 50px;" class="tab-content">
                <div class="tab-pane {%if activetab == 'summary'%}active{%endif%}" id="metadata">
                    <div>
                        <div class="pull-right btn-group">
                            <button style="display: none;" type="button" class="btn" id="show_hide_button">Hide Empty</button>

                            <a id="collapseall_metadata" class="btn" href=""><i class="icon-plus"></i>&nbsp; Expand all</a>
                        </div> 
                        
                    </div>
                    <div class="accordion fullwidth pull-left " id="accordion1" style="margin-top: 10px;">
                        <div id="set_container"></div>
                    </div>


                </div>
            <div class="tab-pane {%if activetab == 'pc'%}active{%endif%}" id="populationcharacteristics" >

              {% include "population_characteristics.html" %}

          </div>

          <div class="tab-pane {%if activetab == 'docs'%}active{%endif%}" id="documents">

            {% include "documents.html" %}
        </div>



        <div class="tab-pane {%if activetab == 'literature'%}active{%endif%}" id="literature">
            <h4 class="loadingsection pull-center">Loading...</h4>

        </div>


        <div class="tab-pane {%if activetab == 'extra'%}active{%endif%}" id="apiinfo">
            <div>
                <a id="btn_pivot_table" class="btn pull-right hidden" href="">Pivot table</a>
            </div>
            <div class="">
                <div id="chart" class="span4" style="display:none;"></div>

                <div  class='span9' id="pivot_table_extra_information">

                </div>

            </div>
            <div class="span8"></div>
        </div>
        <div class="tab-pane {%if activetab == 'discussion'%}active{%endif%}" id="discussion">
            <div class="container-fluid">
                <div id="commentInserted" class="alert alert-success" style="display:none;">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <strong>Comment sent!</strong> Your comment was posted successfully.
                </div>
                <div id="fillForm" class="alert" style="display:none;">
                    <button type="button" class="close" data-dismiss="alert" >&times;</button>
                    <strong><i class="fa fa-arrow-circle-o-down"></i></strong>&nbsp;You need to insert some words here
                </div>
                {% if user.is_authenticated %}
                {% get_comment_form for fingerprint.fingerprint fingerprint_pk as form %}
                <form id="comment_form" action="{% comment_form_target %}" method="POST">
                    <fieldset>
                        {% csrf_token %}
                        <textarea id="id_comment" rows="5" name="comment" class="span7" placeholder="Insert your comment or question here..." autofocus></textarea>
                        {{ form.content_type }}
                        {{ form.object_pk }}
                        {{ form.timestamp }}
                        {{ form.security_hash }}
                        <br />
                        <!--<input type="hidden" name="next" value="{{request.get_full_path}}" />-->
                        <button id="submit_button" class="btn btn-primary" type="submit"  data-loading-text="Sending comment...">Post comment</button>
                    </fieldset>
                </form>
                {% else %}
                <p>Please <a href="{% url 'auth_login' %}">log in</a> to leave a comment.</p>
                {% endif %}
                <br/>
                {% get_comment_count for fingerprint.fingerprint fingerprint_pk as comment_count %}
                <span id="comments_total">{{ comment_count }}</span> comment{{ comment_count|pluralize }}
                <br/>
                <br/>
                {% get_comment_list for fingerprint.fingerprint fingerprint_pk as comment_list %}
                <div id="newComments"></div>
                {% for comment in comment_list reversed%}
                <div id="comment_{{ comment.id }}">
                    <blockquote>
                        <p style="font-size: 16px">{{ comment.comment }}</p>
                        <small>{{ comment.name }} posted on {{ comment.submit_date }}</small>
                    </blockquote>
                </div>
                {% empty %}
                <p>No comments yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
</div>
</div>
{% else %}
<div class="row">
    <div class="span4">
        <div class="alert">
            <a class="close" data-dismiss="error">Ã—</a>
            <strong>Warning!</strong>
            You don't have results.
        </div>
    </div>
</div>
</div>
{% endif %}

<!-- Display a message to users with Javascript deactivated -->
<noscript>
    <div style="position:absolute;top:0;left:0;width:500px;height:250px;border:2px solid #A00;padding:6px;background-color:#fff;color:#600;text-align:center">
        <h1>This page requires Javascript to function properly.</h1>

        <h2>Please follow this instructions on how to
            <a href="http://www.enable-javascript.com/" target="_blank">enable JavaScript in your web browser</a>.</h2>
        </div>
    </noscript>
    {% if isAdvanced %}
    <div id="bool_container"></div>
    {% endif %}

    {% endblock %} 

    {% block scriptextraincludes %}
    <!-- Include the widget embedding script -->
    <script src="//bioinformatics.ua.pt/becas/embed-widget.js"></script>


<!--[if lte IE 8]>
    <script src="{{ STATIC_URL}}js/d3/r2d3.min.js" charset="utf-8"></script>
    <![endif]-->
    <!--[if gte IE 9]><!-->

    <script src="{{ STATIC_URL}}js/d3/d3.v3.min.js" charset="utf-8"></script>
    <script src="{{ STATIC_URL}}js/d3/d3.layout.cloud.js"></script>
    <script src="{{ STATIC_URL}}js/c3.js"></script>   
    <!--<![endif]-->


    <script src="{{ STATIC_URL}}js/database_info.js"></script>
    <script src="{{ STATIC_URL }}js/emif.database.delete.js"></script>
    <script src="{{ STATIC_URL}}js/emif.discussion.js"></script>

    <!--[if gte IE 9]><!-->
    <script src="{{ STATIC_URL}}js/emif.populationcharacteristics.charts.js"></script>

    <script src="{{ STATIC_URL}}js/emif.populationcharacteristics.js"></script>
    <!--<![endif]-->

    <script src="{{ STATIC_URL}}js/vendor/patternrecognizer.js"></script>


{% endblock %}

{% block scriptextra %}
var threads = {};
function load_questionnary(){

console.log("Creating questionnary set containers (so they are in order)");

var containers = [];

// We build the qs containers in memory and just do dom op, on the end, for speed
// on ie joins are significantly faster than concatenation
{% for k, qs in qsets.ordered_items %}
containers.push('<div class="accordion-group"><div class="accordion-heading"><a style="display: inline-block; width: 90%;" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion1" href="#collapse{{ k|removespaces|safe|clean }}">{{ k|removeh1 }} </a><span class="accordion-icon">{% if qs.info %}<img title="This section has search keywords" class="markered" src="{{STATIC_URL}}/img/marker.png" />{% endif %}</span></div><div id="collapse{{ k|removespaces|safe|clean }}" class="accordion-body collapse"><div id="qs_{{ qs.sortid }}" class="accordion-inner"><h4 class="pull-center">Loading...</h4></div></div></div>');

{% if qs.info %}
console.log("QS_DEBUG: {{qs.sortid}} : {{qs.info}}");
{% endif %}



{% endfor %}

$('#set_container').append(containers.join(''));

console.log( "Loading questionnary by parts, we have {{qsets|length}} sets");  

var threadpool = new ThreadPool(20);
parts_missing = {{qsets|length}};


// i dont everything on a single run, because i just add the containers all at once, not by parts
// only the constainers content are loaded by parts

var priority=1;
{% for k, qs in qsets.ordered_items %}
var thread = new Runnable(loadqspart, priority++, {{qs.sortid}}, '{{fingerprint_id}}');

threadpool.run(thread);
threads['qs_{{ qs.sortid }}'] = thread;
{% endfor %}

//  we add the triggers thread
threadpool.destroy(function(){
    $('#show_hide_button').fadeIn();
});
}
function loadqspart(sortid, pk){
$.get( "fingerprintqs/"+pk+"/"+sortid+"/", function( data ) {
$( "#qs_"+sortid ).html( data );
// Mark the tab as highlighted if there's any highlight inside it


/*var highlights = $("#qs_"+sortid).find('.highlight');

//console.dir(highlights);

if(highlights.length > 0){
var this_row = $( "#qs_"+sortid ).parent().siblings().find('.accordion-icon');
this_row.html('<img title="This section has search keywords" class="markered" src="{{STATIC_URL}}/img/marker.png" />');
$(".markered" ,this_row).tooltip({container: "body"});
$(".markered" ,this_row).click(function(){
this_row.parent().siblings().first().collapse('toggle');
});
}  */   

    var erec = new EmailRecognizer("#qs_"+sortid+" td");
    var results = erec.match();
        if (results > 0)
            erec.applyMasks();

    var lrec = new LinkRecognizer("#qs_"+sortid+" td.captioned_content");
    var results = lrec.match();
        if (results > 0)
            lrec.applyMasks();

});    

threads['qs_'+sortid] = null;
parts_missing--;
this.complete();
}
<!-- This must be here because of dynamic code -->
$(document).ready(function() {

        bindPostCommentHandler('{{ request.user.first_name }}', '{{ request.user.last_name }}', '{{ request.user.username }}', '{{owners}}', '{{fingerprint_id}}', '{{breadcrumb_name}}');
//load_questionnary();
    $('.tabbable a[data-toggle="tab"]').on('shown', function (e) {
        if(e.target.textContent == 'Population Characteristics'){
          console.log("test");
        }
    });
    load_questionnary();
    // On expand event, we burst the priority of this thread to load before the others
    $('.accordion-heading').click(function(){
        var load_faster = $('.accordion-inner', $(this).parent()).attr('id');
        console.log("Thread state for "+load_faster+": "+threads[load_faster]);        
        if(threads[load_faster] != null){
            threads[load_faster].setPriority(0);
        }        
    });

    var json_aux = '{{apiinfo|safe}}';

    
    if (json_aux == '' || json_aux == null || json_aux.length == 2) {
        $("#pivot_table_extra_information").html('No information available. You can add information from external applications with <a href="api-info">API web services.</a>');
    } else {
        $("#btn_pivot_table").removeClass("hidden");
        $("#btn_pivot_table").addClass("show");
        json_aux = json_aux.replace("/&quot;/g", "\"");
        
        json = JSON.parse(json_aux);
        //console.log(json_aux);
        //console.log(json);
        var json2 = json;
        json = json_to_d3json(json);
        json.x0 = 0;
        json.y0 = 0;
    
        update(root = json);
        $("#pivot_table_extra_information").html(json_to_table(json2));
    }

        $('#show_hide_button').click(function(){
           if($(this).hasClass('hiding_empty')){
            $(this).removeClass('hiding_empty');
            $(this).text('Hide Empty');

            // Show empty
            $('.hide_empty_content').removeClass('hide_empty_content');

            // double check expansions
            //$("#collapseall_metadata").click();
            //$("#collapseall_metadata").click();

           } else {
            $(this).addClass('hiding_empty');
            $(this).text('Show Empty');

            // Hide empty
            $('.value_content').each(function(){
                if( $(this).text().trim().length == 0){
                    $(this).parent().addClass('hide_empty_content');
                }
            });

            $('.hide_empty_content').parent().parent().each(function(){
                var visible = $(this).find('tr:visible').length;
                if (visible === 1){
                    $(this).parent().parent().parent().addClass('hide_empty_content');
                }
            });
           }
        });
    });
    /* On tab change, to literature tab, lazy load literature tab */
    $(document).on('shown', 'a[data-toggle="tab"]', function (e) {
        if($(e.target).text().toLowerCase().indexOf('literature')!=-1){
            // if not loaded yet
            if($('#literature').find('.loadingsection').length != 0){
                console.log("Loading literature, since it was not loaded yet.");
                $.get( "literature/{{fingerprint_id}}", function( data ) {
                    $( "#literature" ).html( data );
                });
            }

        }
    });
 {% if isAdvanced %}
 var bool_container;
$(function(){

    bool_container = $('#bool_container').boolrelwidget({view_only: true, view_serialized_string: '{{request.session.serialization_query}}', link_back: $('#base_link').prop('href')+"advancedSearch/{{request.session.query_type}}/1/{{request.session.query_id}}"});


});
{% endif %}

{% endblock %}

