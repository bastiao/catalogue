{% extends 'base.html' %}
{% load url from future %}
{% load extra_tags %}
{% load django_bootstrap_breadcrumbs %}

{% block breadcrumbs %}
    {{ block.super }}
    {% breadcrumb "Compare Databases" "" %}

{% endblock %}

{% block scriptextraincludes %}
<script src="static/js/vendor/tablediff.js"></script>

{% endblock %}


{% block styleextra %}
    


   table {
  table-layout: fixed;
}
th, td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  -o-text-overflow: ellipsis;
  -ms-text-overflow: ellipsis;
}

.tooltip.in {
  opacity: 0.8;
  filter: alpha(opacity=80);
}
.tooltip.in {
  opacity: 1;
  filter: alpha(opacity=100);
}

{% endblock %}


{% block toolbar %}
<form id="result_form" action="resultscomp" method="POST">
  {% csrf_token %}
  <div class="span6">
    <div class="btn-group pull-right">

      <div class="btn-group"></div>
      
      <a id="collapseall" class="btn" href="" >
        Expand all
      </a>

      

      <div class="btn-group">
        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
    Show/Hide
    <span class="caret"></span>
  </a>

  <ul class="dropdown-menu">
    <!-- dropdown menu links -->
    <li><a id="match" href="#"><i id="imatch" class="icon-ok icon-white active"></i> Match</a></li>
    <li><a id="unmatch" href="#"><i id="iunmatch" class="icon-ok icon-white active"></i>  Unmatch</a></li>
    <li><a id="proximity" href="#"><i id="iproximity" class="icon-ok icon-white active"></i>  Proximity</a></li>
    <li><a id="emptyrows" href="#"><i id="iemptyrows" class="icon-ok icon-white disabled"></i>  Empty rows</a></li>
  </ul>

</div>

    </div>
  </div>
  </form>
  {% endblock %}

{% block content %}
<div class="clearboth">
<input type="text" size="60" style="margin-left: 0px;" class="span12" id="searchfilter" placeholder="To filter type here" tabindex="1">
</div>

<div style="margin: 0px;" class="span12">
  <div style="overflow: auto;" class="well accordion" id="accordion2">
  <table id="database_listings"><tr>
    {% for name, qset in results %}
                      
    <td class="database_listing" style="min-width: 500px;">
    <div {% if forloop.first%}style="margin-left: 0px;"{% endif %}>
      <span style="cursor: pointer;" class="pull-left label label-inverse">{{name}}</span>
      <span onclick="alert('set reference to {{name}}');" class="set_reference pull-right label label-info">Set as reference table</span>
      <br />

      {% for k,v in qset.items %}
      <div style="background-color: white" class="accordion-group">
        <div class="accordion-heading">
          <a id="a_collapse{{k|removespaces}}_{{name|removespaces}}" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse{{k|removespaces}}_{{name|removespaces}}">{{k|removeh1}}</a>
        </div>
        <div id="collapse{{k|removespaces}}_{{name|removespaces}}" class="accordion-body collapse">
          <div class="accordion-inner">

            <table id="{{name|removespaces}}_{{k|removespaces}}" class="table table-bordered table-hover table-striped">
              <thead></thead>

              <tbody>
                {% for t in v.list_ordered_tags %}
                <tr class="entry">
                  <td data-original-title="{{ t.tag|removehs }}" title="">{{ t.tag|removehs }}</td> 
                   <td data-original-title="{{ t.value }}" title="">{{ t.value }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    </td>
    {% endfor %}
    </tr></table>
    <div id="no_results" class="pull-center">No results found, for this filtering parameters.</div>
  </div>
</div>
</div>  

{% endblock %}



{% comment %}
<script type="text/javascript" >
{% endcomment %}
{% block scriptextra %}


$("#collapseall").bind('click',function(e)
        { 
          //e.preventDefault(); 
          //e.stopPropagation();
          
          collapse_expand(this);
            
          return false;
        });

function collapse_expand(context){
          if ($(context).text().indexOf('Collapse')!==-1)
          {
            $(context).text('Expand all');
            //change_name_collapse(false);

            $(".collapse:visible").collapse("hide");

          }
          else
          {
              $(context).text('Collapse all');
              //change_name_collapse(true);
              $(".collapse:visible").collapse("show");
          }  
}
function doublecheck_expansions(){
          context = $("#collapseall");

          if ($(context).text().indexOf('Collapse')!=-1)
          {
              $(".collapse:visible").collapse("show"); 
          }
          else
          {
              $(".collapse.in:visible").collapse("hide");
          } 
}
function check_empties(){
  var dbs_visible = $('#database_listings .database_listing .accordion-group:visible').length;
  
  if(dbs_visible == 0){
    $('#database_listings').hide();
    $('#no_results').show();

  } else {
    $('#database_listings').show();
    $('#no_results').hide();

  }
}
function reset_empties(){
  $('#database_listings').show();
  $('#no_results').hide();
  
    
}
var match=true;
var unmatch=true;
var emptyrows=true;
var proximity=true;

function applyFilters(){
  reset_empties();

  var filter_string = $("#searchfilter").val();
          {% for name, qset in results %}
            {% for k,v in qset.items %}

            filter_results(['{{name|removespaces}}_{{k|removespaces}}'], 
                            filter_string, match, unmatch, emptyrows, proximity);
          {% endfor %}
          {% endfor %}  

  doublecheck_expansions();
  check_empties();  

}

$("#match").bind('click',function(e)
{ 

          e.preventDefault(); 
          e.stopPropagation();

          match = !match;

          if (!match)
          {
            $('#imatch').removeClass('icon-ok') 

          }
          else
          {
            $('#imatch').addClass('icon-ok')
          }
          applyFilters();

          return false;
});

$("#unmatch").bind('click',function(e)
{ 

          e.preventDefault(); 
          e.stopPropagation();

          

          unmatch = !unmatch ;
          applyFilters();
          if (!unmatch)
          {
            $('#iunmatch').removeClass('icon-ok') 
          }
          else
          {
            $('#iunmatch').addClass('icon-ok')
          }
          return false;
});


$("#emptyrows").bind('click',function(e)
{ 

          e.preventDefault(); 
          e.stopPropagation();

          

          emptyrows = !emptyrows ;
          applyFilters();
          if (!emptyrows)
          {
            $('#iemptyrows').removeClass('icon-ok') 
            
          }
          else
          {
            $('#iemptyrows').addClass('icon-ok')
          }
          return false;
});




$("#proximity").bind('click',function(e)
{ 

          e.preventDefault(); 
          e.stopPropagation();


          proximity = !proximity ;
          applyFilters();

          if (!proximity)
          {
            $('#iproximity').removeClass('icon-ok') 
            
          }
          else
          {
            $('#iproximity').addClass('icon-ok')
          }
          return false;
});

/*
 * delayKeyup
 * http://code.azerti.net/javascript/jquery/delaykeyup.htm
 * Inspired by CMS in this post : http://stackoverflow.com/questions/1909441/jquery-keyup-delay
 * Written by Gaten
 * Exemple : $("#input").delayKeyup(function(){ alert("5 secondes passed from the last event keyup."); }, 5000);
 */
(function ($) {
    $.fn.delayKeyup = function(callback, ms){
        var timer = 0;
        $(this).keyup(function(e){
            e.preventDefault(); 
            e.stopPropagation();  

            clearTimeout (timer);
            timer = setTimeout(callback, ms);
        });
        return $(this);
    };
})(jQuery);

$("#searchfilter").delayKeyup(
    function(){

      applyFilters();

      return false;
    }
  , 500);


function hidecheckbox()
{
  console.log("togle");
  $('.checkbox').toggle();
}


myFunc = function(name)
{
  //console.log(this);
  //console.log(name);
  var current = this.id;
  current = current.replace("a_", "");
  current = current.split("_")[0];
  //console.log(this.parent);
  
   $('div[id]').filter(function () {
    return /^collapse.*$/.test(this.id);
}).each(function (name2) {
    //console.log(name2);
});




$("div[id^='collapse']").filter(function(){
    var regexp = /^collapse(.*)$/;
    return (this.id.match(regexp));
}).each(function(){
    //this.innerHTML = this.id;
    //console.log(this.id);
    //console.log(current);
    if (!this.id.indexOf(current))
    { 
      $('#'+this.id).collapse('toggle'); 
    };
});



};
$('body').on('click', '.accordion-toggle', myFunc);



/*

function highlight(text, text_to_highlight)
{
    inputText = document.getElementById("inputText")
    var innerHTML = inputText.innerHTML
    var index = innerHTML.indexOf(text);
    if ( index >= 0 )
    { 
        innerHTML = innerHTML.substring(0,index) + "
<span class='highlight'>" + innerHTML.substring(index,index+text.length) + "</span>
" + innerHTML.substring(index + text.length);
        inputText.innerHTML = innerHTML 
    }

}

*/

$.fn.textWidth = function() {
  var node, original, width;
  original = $(this).html();
  node = $("<span style='position:absolute;width:auto;left:-9999px'>" + original + "</span>");
  //node.css('font-family', $(this).css('font-family')).css('font-size', $(this).//css('font-size'));
  $('body').append(node);
  width = node.width();
  node.remove();
  return width;
};

$(function() {
  $('td').each(function() 
  {

    var content;
    content = $(this).text().replace(/\s+/gi, ' ');

    
    if ($(this).textWidth() > $(this).width()) {
    
      return $(this).tooltip({container:"body"});
    }
  });
});


{% for name, qset in results %}

{% if not forloop.first %}
{% for k,v in qset.items %}
/*
tablediffall_two('{{database_to_compare|removespaces}}_{{k|removespaces}}',['{{name|removespaces}}_{{k|removespaces}}'] )
*/
tablediffall_two('{{database_to_compare|removespaces}}_{{k|removespaces}}', ['{{name|removespaces}}_{{k|removespaces}}'])

{% endfor %}
{% endif %}


{% endfor %}

{% comment %}
</script>
{% endcomment %}


{% endblock %}