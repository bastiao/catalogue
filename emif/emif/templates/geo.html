{% extends 'base.html' %}
{% load url from future %}
{% load extra_tags %}
{% load django_bootstrap_breadcrumbs %}

{% block breadcrumbs %}
{{ block.super }}

{% if search_old %}
    {% breadcrumb "Search" "resultsdiff/1" %} 
{% else %}
    {% breadcrumb "Databases" "alldatabases" %}
{% endif %}
{% if search_old and not isAdvanced %}
{% breadcrumb "Geolocation ("|add:search_old|add:")" "" %}
{% else %}
{% breadcrumb "Geolocation" "" %}
{% endif %}
{% endblock %}

{% block scriptextraincludes %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<link rel="stylesheet"  href="{{STATIC_URL}}css/emif.geo.css">
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/jquery.boolrelwidget.css"></script>
<script src="{{ STATIC_URL}}js/vendor/jquery.boolrelwidget.js"></script>

<script type="text/javascript">
var infowindow = new google.maps.InfoWindow();


var map;
function initialize(list_db) {
	
    var latlng = new google.maps.LatLng(40, -40);
	var myOptions = {
		zoom: 3,
		center: latlng,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	map = new google.maps.Map(document.getElementById("map_canvas"),myOptions);
	
	
	$(list_db).each(function(db_tmp)
	{
                        var _db = list_db[db_tmp];
                        var marker = new google.maps.Marker({
                                                map: map,
                                                position: new google.maps.LatLng(_db.lat, _db.long),
                                                title: ''
                                        });
                        



                        google.maps.event.addListener(marker, 'click', (function (marker) {
            return function () {


                function clean(x){
                    if (x== undefined) {
                        return 'not defined yet';
                    } 
                    return x;
                }
                
                // Build content
                var contentHTML = '<div id="info-window">';

                contentHTML += '<h4>';
                contentHTML += '<a href="fingerprint/'+_db.id + '/1">' + clean(_db.name) + '</a>';
                contentHTML += '</h4>';

                
                    contentHTML += '<div class="organization-address">';
                    if (_db.institution !='')
                        contentHTML += 'Institution name: <b>' + clean(_db.institution) + '</b><br/>';
                    if (_db.contact !='')
                        contentHTML += 'Contact: <b>' + clean(_db.contact) + '</b><br/>';
                    if (_db.ttype !='')
                        contentHTML += 'DB Type: <b>' + clean(_db.ttype) + '</b><br/>';
                    if (_db.number_patients !='')
                    contentHTML += 'Number of patients: <b>' + clean(_db.number_patients) + '</b><br/>';
                
                //# Administrative
                if(!(_db.admin_name =='' && _db.admin_address =='' && _db.admin_email=='' && _db.admin_phone =='')){
                    contentHTML += '<div class="geo-well well">';
                    contentHTML += '<div class="row">';
                    if (_db.admin_name !='')
                    contentHTML += '<i class="icon-user icon"></i> Administrative contact: <b>' + clean(_db.admin_name) + '</b><br />';
                    if (_db.admin_address !='')
                    contentHTML += '<i class="icon-home icon"></i> Address: <b>' + clean(_db.admin_address) + '</b><br/>';
                    if (_db.admin_email !='')
                    contentHTML += '<i class="icon-envelope icon"></i> Email: <b>' + clean(_db.admin_email) + '</b><br/>';
                    if (_db.admin_phone !='')
                    contentHTML += '<i class="icon-phone icon"></i> Phone: <b>' + clean(_db.admin_phone) + '</b><br/>';
                    contentHTML += '</div>';
                    contentHTML += '</div>';

                    contentHTML += '<br />';
                }
                //# Scientific
                if(!(_db.scien_name =='' && _db.scien_address =='' && _db.scien_email =='' && _db.scien_phone =='')){
                    contentHTML += '<div class="geo-well well">';
                    contentHTML += '<div class="row">';
                    if (_db.scien_name !='')
                    contentHTML += '<i class="icon-user icon"></i> Scientific contact: <b>' + clean(_db.scien_name) + '</b><br />';
                    if (_db.scien_address !='')
                    contentHTML += '<i class="icon-home icon"></i> Address: <b>' + clean(_db.scien_address) + '</b><br/>';
                    if (_db.scien_email !='')
                    contentHTML += '<i class="icon-envelope icon"></i> Email: <b>' + clean(_db.scien_email) + '</b><br/>';
                    if (_db.scien_phone !='')
                    contentHTML += '<i class="icon-phone icon"></i>  Phone: <b>' + clean(_db.scien_phone) + '</b><br/>';
                    contentHTML += '</div>';
                    contentHTML += '</div>';
                    contentHTML += '<br />';
                }
                //# Tecnical
                if(!(_db.tec_name =='' && _db.tec_address =='' && _db.tec_email =='' && _db.tec_phone =='')){
                    contentHTML += '<div class="geo-well well">';
                    contentHTML += '<div class="row">';
                    if (_db.tec_name !='')
                    contentHTML += '<i class="icon-user icon"></i> Tecnical contact: <b>' + clean(_db.tec_name) + '</b><br/>';
                    if (_db.tec_address !='')
                    contentHTML += '<i class="icon-home icon"></i> Address: <b>' + clean(_db.tec_address) + '</b><br/>';
                    if (_db.tec_email !='')
                    contentHTML += '<i class="icon-envelope icon"></i> Email: <b>' + clean(_db.tec_email) + '</b><br/>';
                    if (_db.tec_phone !='')
                    contentHTML += '<i class="icon-phone icon"></i> Phone: <b>' + clean(_db.tec_phone) + '</b><br/>';
                    contentHTML += '</div>';
                    contentHTML += '</div>';

                    contentHTML += '</div>';


                    contentHTML += '<br/>';
                }
                contentHTML += '</div><br/>';
                infowindow.setContent(contentHTML);
                infowindow.open(map, marker);
            }
        })(marker));	


	});

}

var list_db = []

{% for db in db_list %}

list_db.push({name: '{{db.name}}',
            {%comment%}location: '{{db.location}}',{%endcomment%}
            institution: '{{db.institution}}',
            contact: '{{db.email_contact}}',
            number_patients: '{{db.number_patients}}',
            ttype: '{{db.ttype}}',
            id : '{{db.id}}',
            admin_name: '{{db.admin_name}}',
            admin_address: '{{db.admin_address}}',
            admin_email: '{{db.admin_email}}',
            admin_phone: '{{db.admin_phone}}',
            scien_name: '{{db.scien_name}}',
            scien_address: '{{db.scien_address}}',
            scien_email: '{{db.scien_email}}',
            scien_phone: '{{db.scien_phone}}',
            tec_name: '{{db.tec_name}}',
            tec_address: '{{db.tec_address}}',
            tec_email: '{{db.tec_email}}',
            tec_phone: '{{db.tec_phone}}',
            lat : '{{db.lat}}',
            long: '{{db.long}}'
            });

{% endfor %}


load_map = function(db_list)
{
	initialize(db_list);
}

$(document).ready(load_map.bind(window,list_db));




</script>


{% endblock %}


{% block scriptextra %}

 {% if isAdvanced %}
 var bool_container;
$(function(){
    bool_container = $('#bool_container').boolrelwidget({view_only: true, view_serialized_string: '{{request.session.serialization_query}}', link_back: $('#base_link').prop('href')+"advancedSearch/{{request.session.query_type}}/1/{{request.session.query_id}}"});
});
  {% endif %}

{% endblock %}

{% block styleextra %}
  #map_canvas { width: 100%; height: 600px; }
{% endblock %}


{% block content %}
{% if isAdvanced %}
<div id="bool_container"></div>
{% endif %}
<div id="map_canvas"></div>

{% endblock %}

