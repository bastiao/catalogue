{% extends 'base.html' %}
{% load extra_tags %}
{% load url from future %}
{% load django_bootstrap_breadcrumbs %}

{% block breadcrumbs %}
    {{ block.super }}
    {% breadcrumb "Search" "resultsdiff/1" %}
{% if not isAdvanced %}
    {% if search_old == None %}
        {% breadcrumb "None" "" %}
    {% else %}
        {% breadcrumb search_old "" %}
    {% endif %}
{% endif %}
{% endblock %}


{% block headextra %}
<link rel="stylesheet" href="static/css/theme.blue.css">
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/jquery.boolrelwidget.css"></script>

{% endblock %}


{% block scriptextraincludes %}

<script src="{{ STATIC_URL}}js/vendor/jquery.boolrelwidget.js"></script>
<script src="{{ STATIC_URL }}js/vendor/jquery.ba-throttle-debounce.min.js"></script>
<script src="{{ STATIC_URL }}js/paginator-sorter.js"></script>


{% endblock %}


{% block styleextra %}

.hoverDiv {background: #fff;}
.hoverDiv:hover {background: #E8E8E8;}

{% endblock %}

{% block toolbar %}
{% if page_obj != None %}
  <div class="span6">
    <div class="btn-group pull-right">

      <div class="btn-group"></div>
      <a id="comparabtn" class="btn "  href=""  rel="tooltip" data-container="body" data-placement="bottom" data-original-title="This allows to compare databases.<br /> It is only possible to compare databases of the same type.  For instance, you cannot compare databases from AD Cohort with a databases from Observational Data.<br /> When a database is selected, the type is defined automatically, and databases of other types cannot be chosen. <br /> To be able to select other type, you must unselect all the databases." class="help_selectresults icon-question-sign" disabled> <i  class=" icon"></i>
        Compare</a>

      <a class="btn" href="geo" onclick="" > <i class=" icon"></i>Geolocation</a>

    </div>
  </div>
         {% endif %}
  {% endblock %}

{% load bootstrap_pagination %}

{% block content %}

{% if isAdvanced %}
<div id="bool_container"></div>
{% endif %}
  <div id="row_loading" class="row">


    <div class="span12" style="text-align:center">
      <div class="navbar" id="loading">
        <div class="navbar-inner">

          <h4>
              <span id="results_size"></span>
            {% if page_obj != None %}
            Total results 
              {%if not isAdvanced %}
                for {{search_old}}
              {% endif %}
            <span class="label label-inverse"> {{num_results}}</span>
            {% else %}
            No results found 
          {% endif %}
          </h4>
        </div>
      </div>
    </div>
    </div>
    {% if page_obj != None %}
    <form id="result_form" action="resultscomp" method="POST">
  {% csrf_token %}
<table class="table table-bordered table-hover fingerprint_table table-striped" id="table_databases" data-provides="rowlink">
    <thead>
        <tr>
            <th class="sorter {%if "icon-minus" not in sort_params.database_name.icon %}selected-sorter{% endif %}"  onclick="a.onClick('database_name', '{{sort_params.database_name.next}}');">
            <div class="pull-left">Name</div>
                 <div class="pull-right"><i class="{{sort_params.database_name.icon}}"></i></div>
            </th>
            <!--<th>Creation Date</th>-->
            <th class="sorter {%if "icon-minus" not in sort_params.last_update.icon %}selected-sorter{% endif %}" onclick="a.onClick('last_update', '{{sort_params.last_update.next}}');">
            <div class="pull-left">Last update</div>
                <div class="pull-right"><i class="{{sort_params.last_update.icon}}"></i></div> 
            </th>
            <th class="sorter {%if "icon-minus" not in sort_params.type.icon %}selected-sorter{% endif %}" style="width: 200px;" onclick="a.onClick('type', '{{sort_params.type.next}}');">
            <div class="pull-left">Type</div>
              <div class="pull-right"><i class="{{sort_params.type.icon}}"></i></div> 
            </th>
            <th class="sorter-false filter-false">Select</th>

        </tr>
        <tr>
          <td class="table_filter">
                <input class="filter_input" id="database_name_filter" type="text" value="{{sort_params.database_name.filter}}" placeholder="Filter">
          </td>
           <td class="table_filter">
                 <input class="filter_input" id="last_update_filter" type="text" value="{{sort_params.last_update.filter}}" placeholder="Filter">
          </td>
           <td class="table_filter">
              <select id="type_filter" class="selectpicker" def_value="{{sort_params.type.filter}}">
                <option value="">None</option>
                <option value="adcohort">AD Cohort</option>
                <option value="observationaldatasources">Observational Data Sources</option>
              </select>
          </td>
          <td style="width:50px;" class="table_filter">
            <div style="text-align: center;">
              <i data-toggle="tooltip" data-placement="bottom" title="This allows to compare databases.<br /> It is only possible to compare databases of the same type.  For instance, you cannot compare databases from AD Cohort with a databases from Observational Data.<br /> When a database is selected, the type is defined automatically, and databases of other types cannot be chosen. <br /> To be able to select other type, you must unselect all the databases." class="help_selectresults icon-question-sign"></i>
            </div>
          </td>
        </tr>
    </thead>
    <tbody id="table_content">

  {% for t in page_obj %}
   <tr>          
          <td>
            <a href="fingerprint/{{ t.id }}/1">{{ t.name }}</a>

            <div style="margin-left:20px">
             Institution Name: {{t.institution}}
            </div>

            <div style="margin-left:20px">
             Location: {{t.location}}
            </div>
            <div style="margin-left:20px">
             Number of patients: {{t.number_patients}}
            </div> 
        </td>
          <td class="date">            
                {% if t.last_activity %}
                    {{t.last_activity|datehhmm}}
                {% else %}
                    {{ t.date }}
                {% endif %}
          </td>
          <td class="type">{{ t.type_name }} </td>
          
        
          <td style="text-align:center"> <input class="checkbox dbtype_{{t.type_name|removespaces}}" type="checkbox" name="chk_{{ t.id }}"></td>

          
        </tr>


  {% comment %}
    <div class="span12" >
      <div class="navbar" id="loading">

        <div class="navbar-inner hoverDiv">
          <div class="row-fluid hoverDiv">
            <div class="pull-left span6" style="text-align:left">
              <a href="fingerprint/{{ result.id }}/1">
                <span class="label label-success" style="font-size:15px">{{ result.name }}</span>
              </a>
              <div >Institution Name: {{result.institution}}</div>

              <div >Location: {{result.location}}</div>
              <div >Number of patients: {{result.number_patients}}</div>

              <div >Last change: {{result.date}}</div>
            </div >
            <div class="span5" style="margin-top:60px">
              <div class="row " >

                <div class="span1 pull-right" style="text-align:right; padding-top:5px; max-width:15px;">

                  <input class="checkbox" type="checkbox" name="chk_{{ result.id }}"></div>

                <div class="span3 pull-right " style="max-width:165px">
                  <a class="btn btn-small btn-success" href="contact/{{result.email_contact}}">Contact</a>
                  
                  <a class="btn btn-small btn-success" href="fingerprint/{{result.id}}/1/">Fingerprint</a>
                  
                  <a class="btn btn-small btn-success" href="advancedSearch/1">More like this</a>
                  
                </div>

              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
    {% endcomment %}
    {% endfor %}

    </tbody>
</table>
<script type="text/javascript">
var a;
$(document).ready(function(){
    a = new PaginatorSorter("table_databases", '{{sort_params.base_filter}}', '{{sort_params.selected_name}}', '{{sort_params.selected_value}}');
    paginator_via_post();
});
</script>

  </form>
  <form id="send2" method="POST" > 
  <input id="page" type="hidden" name="page" value="{{page}}"></input>
  <input id="s" type="hidden" name="s" value=""></input>  
    <input id="submit_simulate" style="display:none" type="submit" value="Submit">

{% csrf_token %}
</form>
    {% else %}
    <div style="margin-top: 60px;"></div>
  {% endif %}

  {% if page_obj != None %}
    {% bootstrap_paginate page_obj range=10 url_view_name="views.results_diff" show_prev_next="false" show_first_last="true" %}

{% endif %}
{% endblock %}

{% comment %}
  <script type="text/javascript" >
{% endcomment %}

{% block scriptextra %}

{% if page_obj != None %}

var counter = 0;

// URL Hack to make paginator work with base
$(document).ready(function(){

    if($('input:checkbox:checked', table_databases).length >= 1){
      var classes = $('input:checkbox:checked', table_databases).first().prop("class").split(' ');
      var a_class = null;
      for(var i=0;i<classes.length;i++){
        if(classes[i].indexOf('dbtype_') != -1)
          a_class=classes[i];
      }
      if(a_class){
        console.log("["+a_class+"]");
        $(".checkbox").prop( "disabled", true );

        $("."+a_class).prop("disabled", false);
      }
    }
    
    if($('input:checkbox:checked', table_databases).length >= 2){
        $("#comparabtn").removeAttr('disabled');
        counter = $('input:checkbox:checked', table_databases).length;
        $("#comparabtn").bind('click',function(e)
        { 
          
          $('#result_form').submit();

          return false;
        });
    }
    
    $('a[href="#"]').attr('href', function(i, val){
        return window.location + val;
    });

    $('.help_selectresults').tooltip({container: 'body', 'html': true});
    
});
{% endif %}

 {% if isAdvanced %}
 var bool_container;
$(function(){
    bool_container = $('#bool_container').boolrelwidget({view_only: true, view_serialized_string: '{{request.session.serialization_query}}', link_back: $('#base_link').prop('href')+"advancedSearch/{{request.session.query_type}}/1/{{request.session.query_id}}" });
   
    window.setTimeout(function(){window.location.hash = "#back";}, 100);
    window.setTimeout(function(){window.location.hash = "#search";}, 100);

});
  /* This is a trick, to be able to redirect on back button since browsers try to prevent us to do so 
   I must do this, because the back url is different from the url on history */
window.onhashchange = function(){
   if (location.hash == "#back") {
        window.location.replace($('#base_link').prop('href')+"advancedSearch/{{request.session.query_type}}/1/{{request.session.query_id}}");
    }
    
}
  {% endif %}
  
function hidecheckbox()
{
  $('.checkbox').toggle();
}

$("#comparabtn").bind('click',function(e)
        { 
          
          e.preventDefault(); 
          e.stopPropagation();
          return false;
        });

//$("#comparabtn").unbind();

$('.checkbox').click(function()
{
    //console.log(counter);
    if($(this).is(':checked')){
        counter++;
    } else 
    {
        counter--;
    }
    console.log(counter);
    if(counter == 0){
      $('.checkbox').prop( "disabled", false);
    }
    else if(counter == 1){
     $("#comparabtn").attr('disabled', true);
      
      $("#comparabtn").unbind();
      $("#comparabtn").bind('click',function(e)
        { 
          
          e.preventDefault(); 
          e.stopPropagation();
          return false;
        });

      var classes = $(this).prop("class").split(' ');
      var a_class = null;
      for(var i=0;i<classes.length;i++){
        if(classes[i].indexOf('dbtype_') != -1)
          a_class=classes[i];
      }
      if(a_class){
        console.log("["+a_class+"]");
        $(".checkbox").prop( "disabled", true );

        $("."+a_class).prop("disabled", false);
      }
      
    }
    else if (counter>=2)
    {
      $("#comparabtn").removeAttr('disabled');
      $("#comparabtn").bind('click',function(e)
        { 
          
          $('#result_form').submit();

          return false;
        });      
    }

});
$('[rel=tooltip]').tooltip({container: 'body', 'html': true});

$('.popover').popover({
    container: 'body'
});
$('.accordion-body.collapse').hover(
function () {
$(this).css('overflow','visible');
}, 
function () {
$(this).css('overflow','hidden');
}
);
{% endblock %}

{% comment %}
</script>
  {% endcomment %}