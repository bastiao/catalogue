{% load extra_tags %}

<div class="span6">
	<div class="btn-group pull-right">


        {% if request.user|safe in users_db and not readonly %}
        <button type="button" class="btn btn active" onclick="edit_db_option();" title="Enable/Disabled edit option" data-toggle="button">
			<i class="fa fa-pencil-square-o"></i> Edit
		</button>
         {% endif %}

		{% if request.user.is_authenticated %} 
		<!--div class="btn-group" id="group_toolbar"-->

      {% if fingerprint_dump %}
      <a class="btn btn morelikethis" href="mlt/{{fingerprint_id}}" id="morelikethis_toolbar"> <i class="icon-search icon"></i>
        More Like This
      </a>
      {% endif %}
      {% if fingerprint_dump and not owner_fingerprint %}
      <a class="btn" href="dbDetailed/{{fingerprint_id}}/{{fingerprint_ttype}}" id="detailed_list_toolbar" title="Detailed View of Database" title="Detailed View Database"> <i class="icon-eye-open icon"></i>
        Detailed
      </a>
      {% endif %}
      {% if add_databases or not hide_add %}
	      <div class="btn btn-group">
        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#" id="add_list_toolbar">
         <i class="icon-plus icon"></i> Add
          <span class="caret"></span>
        </a>
        <ul class="pull-right dropdown-menu">
           {% show_fingerprints_interests request.user %}
        </ul>
      </div> 
      {% endif %}
		<!--/div-->
		{% endif %}
        {% if  collapse %}
		 <a id="collapseall" class="btn" href="#" >
            Expand all
         </a>
        {% endif %}
        {% if list_databases|length > 0 and not no_print %}
		<button type="button" class="btn btn" onclick="window.print();" title="Print">
			<i class="icon-print"></i> Print
		</button>
        {% endif  %}
	  {% if  geo %}
      <a class="btn" href="geo" onclick="" > <i class=" icon"></i>
        <i class="icon-globe"></i> Geolocation
      </a>
      {% endif %}

      {% if data_table %}
      <a class="btn" href="alldatabases/data-table" onclick="" > <i class="icon icon-th"></i>
        Data table
      </a>
      {% endif %}

      {% if export_datatable and request.user.is_superuser %}
      
        <button id="exportdatatable" class="btn" onclick="showExportMessage();"> <i class="fa fa-upload"></i> Export </button>
      {% endif %}

      {% if export_all_answers and request.user.is_superuser %}
      <a class="btn" href="export_all_answers" onclick="showExportMessage();" > <i class="fa fa-upload"></i>
        Export
      </a>
      {% endif %}

      {% if export_bd_answers and request.user.is_superuser %}
      <a class="btn" href="export_bd_answers/{{ fingerprint_id }}" onclick="showExportMessage();" > <i class="fa fa-upload"></i>
        Export
      </a>
      {% endif %}

      {% if export_my_answers and request.user.is_superuser %}
      <a class="btn" href="export_my_answers" onclick="showExportMessage();" > <i class="fa fa-upload"></i>
        Export
      </a>
      {% if isSearch and request.user.is_superuser %}
      <a class="btn" href="export_search_answers" onclick="showExportMessage();" > <i class="fa fa-upload"></i>
        Export
      </a>
      {% endif %}     
      {% endif %}
      {% if request.user.is_superuser %}
            {% if  api_token %}
                <a class="btn" href="api-info"> <i class=" icon"></i>
                 <i class="icon-info-sign"></i> API Info
                </a>
            {% endif %}
      {% endif %}
      {% if fingerprint_dump and owner_fingerprint or fingerprint_dump and request.user.is_superuser %}
      <div class="btn btn-group">
        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
          <i class="fa fa-cogs"></i> Manage
          <span class="caret"></span>
        </a>
        <ul class="pull-right dropdown-menu">
        <li>
          <a href="dbEdit/{{fingerprint_id}}/{{fingerprint_ttype}}" id="edit_list_toolbar" title="Edit Database" title="Share Database"> <i class="icon-pencil icon"></i>
        Edit
      </a>
      </li>
      <li>
      <a class="sharedb" href="" id="share_list_toolbar" onclick="return false;"> <i class="icon-share icon"></i>
        Share
        
      </a>
      </li>
      <li>
      <a class="confirm-delete" href="" id="delete_list_toolbar" onclick="return false;"data-id="{{ fingerprint_id }}"  title="Remove Database"> <i class="icon-trash icon"></i>
        Delete
        
      </a> 
      </li>     
        </ul>
      </div>      
      {% endif %}
		

	</div>
</div>
<!-- **********************************************************************
***** Model to delete the fingerprint. It will show a window to confirm the
***** deletion of the fingerprint
 ***************************************************************************-->


<div id="modal-from-dom" class="modal hide fade" style="display:none"  >
    <div class="modal-header">
        <a href="#" onclick="$('#modal-from-dom').modal('hide'); return false;" class="close">&times;</a>
         <h3>Delete Fingerprint</h3>
    </div>
    <div class="modal-body">
        <p>You are removing the database fingerprint <strong>'<span id="db-name">{{breadcrumb_name}}</span>'</strong>. This procedure is irreversible.</p>
        <p>Do you want to proceed?</p>
        <p id="debug-url"></p>
    </div>
    <div class="modal-footer">
        <a href="rm/ref" class="btn btn-danger">Yes</a>
        <!-- <a href="delete.php?some=param&ref=" class="btn danger">Yes 2</a> -->
        <a href="#" onclick="$('#modal-from-dom').modal('hide'); return false;" class="btn btn-secondary">Cancel</a>
    </div>
</div>


<!-- **********************************************************************
***** Model to share the fingerprint. It will show a window to share the
***** the fingerprint. A list of email addresses should entered. 
 ***************************************************************************-->

<div id="modal-from-dom-share" class="modal hide fade" style="display:none"  >
    <div class="modal-header">
        <a href="#" onclick="$('#modal-from-dom-share').modal('hide'); return false;" class="close">&times;</a>
         <h3>Share Database</h3>
    </div>
    <div class="modal-body">
        <p>What is the email address of your team member? (must be a registered user)</p>

        <p id="debug-url"></p>
        <div style="display: table-row;">
          <label style="display: table-cell; padding: 5px;" class="control-label" for="inputEmail">Email: </label>
          <div style="display: table-cell; padding: 5px;" class="controls">
            <input style="margin-top:5px;" type="text" id="share_email"/>
          </div>
          <span style="display: table-cell; padding: 5px;" id="share_indicator">&nbsp;</span>
        </div>
        <div id="share_message"></div>

    </div>
    <div class="modal-footer">
        <button class="btn sharedb2_shadow" disabled>Share</button>
        <!--a style="display:none;" href="#" class="btn sharedb2">Share</a-->
        <button style="display:none;" class="btn sharedb2">Share</button>

        <a href="#" onclick="$('#modal-from-dom-share').modal('hide'); return false;" class="btn btn-secondary">Cancel</a>
    </div>
</div>


<form id="send" method="POST" > {% csrf_token %}
</form>

<form id="senddatatablemodel" method="POST" >
{% csrf_token %}
</form>
<form id="senddatatable" action="export_datatable" method="POST" >
{% csrf_token %}
</form>

<script>


/***************************************************************
************** Delete ******************************************
****************************************************************/
$('#modal-from-dom').bind('show', function() {
    var id = $(this).data('id'),
        removeBtn = $(this).find('.btn-danger'),
        href = removeBtn.attr('href');
    console.log('id' + id);

    removeBtn.attr('href', href.replace('ref', '' + id));
});


$('.confirm-delete').click(function(e) {
    e.preventDefault();
    
    var id = $(this).data('id');
    $('#modal-from-dom').data('id', id).modal('show');
});



/***************************************************************
************** Auxiliar method to post 
****************************************************************/

function post_to_url(path, params, method) {
    method = method || "post"; // Set method to post by default if not specified.

    // The rest of this code assumes you are not using a library.
    // It can be made less wordy if you use one.
    //var form = document.createElement("form");
    var form = document.getElementById("send");
    form.setAttribute("method", method);
    form.setAttribute("action", path);

    for(var key in params) {
        if(params.hasOwnProperty(key)) {
            var hiddenField = document.createElement("input");
            hiddenField.setAttribute("type", "hidden");
            hiddenField.setAttribute("name", key);
            hiddenField.setAttribute("value", params[key]);

            form.appendChild(hiddenField);
         }
    }

    document.body.appendChild(form);
    form.submit();
};

/***************************************************************
************** Shared ******************************************
****************************************************************/
$('#modal-from-dom-share').bind('show', function() {
    var id = $(this).data('id'),
        removeBtn = $(this).find('.sharedb2');
        //href = removeBtn.attr('href');
    
    //removeBtn.attr('href', href.replace('ref', '' + id));
});

// This bind is handle the click in share button
$(".sharedb" ).click(function(e) 
{
  console.log("Share DB ");
  e.preventDefault();
  var id = "{{fingerprint_id}}";

  $('#modal-from-dom-share').data('id', id).modal('show');
       
});
$("#share_email" ).change(function(e) 
{
  checkIfEmailExists();
});
// This bind will share the email. 
$(".sharedb2" ).click(function(e) 
{
  e.preventDefault();
  
  //post_to_url($(this).attr('href'), {"email": $("#share_email").val(), "csrfmiddlewaretoken": $('input[name="csrfmiddlewaretoken"]').prop('value')});
  shareDatabase();

});
function checkIfEmailExists(){
  $('#share_indicator').html('<i class="icon-refresh"></i>');
  $('#share_message').html('<p class="text-info">Check if email is valid for share invitation.</p>');
  $.post("api/emailcheck", { email: $("#share_email").val() })
  .done(function(response) {
    if(response.valid){
      console.log('Email valid');
      $('.sharedb2_shadow').hide();
      $('.sharedb2').show();
      $('#share_indicator').html('<i class="icon-ok text-success"></i>');
        $('#share_message').html('<p class="text-success">Email is valid.</p>');
    } else {
      console.log('Email invalid');
      $('.sharedb2').hide();
      $('.sharedb2_shadow').show();
      $('#share_indicator').html('<i class="icon-remove text-error"></i>');
        $('#share_message').html('<p class="text-error">Email is invalid, doesn\'t belong to any registered user.</p>');

    }

  })
  .fail(function(){
        $('#share_indicator').html('<i class="icon-remove text-error"></i>');
        $('#share_message').html('<p class="text-error">Look up failed, maybe the internet connection is down.</p>');
  });
}

function shareDatabase(){
  $('#share_indicator').html('<i class="icon-refresh"></i>');
  $('#share_message').html('<p class="text-info">Trying to share.</p>');
  $.post("share/{{fingerprint_id}}", { email: $("#share_email").val() })
  .done(function(response) {
    
    $('#share_message').html('<p class="text-info">'+response+'.</p>');

  })
  .fail(function(){
        $('#share_indicator').html('<i class="icon-remove text-error"></i>');
        $('#share_message').html('<p class="text-error">Request failed, maybe the internet connection is down.</p>');
  });
}
</script>
