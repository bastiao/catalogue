
{% load extra_tags %}
{% load markup questionnaire i18n %}

<div class="span8">
    <form name="qform" id="qform" action="dbEdit/{{fingerprint_id}}/{{questionset.questionnaire.pk}}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="active_qs" id="active_qs" value="0" />
        <input type="hidden" name="active_qs_sortid" id="active_qs_sortid" value="0" />
        <input type="hidden" name="fingerprint_id" value="{{ fingerprint_id }}" />
        <input type="hidden" name="users_db" value="{{ users_db }}" />
        <input type="hidden" name="created_date" value="{{ created_date }}" />

    {% setglobal iteratorQ 0 %}
    {% for k, qlist in questions_list %}

        {% setglobal h1_already 0 %}
        {% setglobal h1_last 0 %}


    <div id="qs_{{ k.sortid }}" class="{% if k.sortid == 0 %} {% else %} hide {% endif %} questionset">

    {% if k.sortid != 0 and k.sortid != 99 %}
        <div><a id="collapseall_qs_{{ k.sortid }}"  class="btn pull-right" href="#">Collapse all </a></div>
    {% endif %}

    <div class="questionset-title" style="font-size:6px">
    <h3>{{ k.text|removeh1 }}</h3>

    </div>
    {% if k.help_text != "" %}
    <div class="clearfix" style="padding-bottom:30px;">{{k.help_text|safe}}</div>
    {% endif %}


        {% csrf_token %}

        <input type="hidden" name="questionset_id" value="{{ questionset.id }}" />

        <div class="accordion" id="accordion_{{ k.sortid }}">

        {% for question, qdict in qlist %}

            {% incrementglobal iteratorQ %}

            {% with errors|dictget:question.number as error %}

                {% if question.text|geths == 'h1' %}

                    <!-- If has already appear another h1 before close accordion-group -->
                    {% if h1_already.value == '1' %}

                        </div>
                        </div>
                        </div>

                    {% endif %}

                    <!-- Set variable h1 to accordion -->
                    {% setglobal h1_already 1 %}
                    {% setglobal h1_last 1 %}

                    <div class="accordion-group {{qdict.depon_class}}" id="acc_qc_{{ question.number }}" {{qdict.checkstring|safe}}>
                        <div class="accordion-heading">
                            {% if request.user.is_staff %}
                                <span class="pull-right"> <a href="admin/questionnaire/question/{{ question.id }}/">
                                    <i class="icon-pencil">&nbsp;</i>
                                </a></span>
                            {% endif %}
                            <span class="pull-right">
                                <a href="#" onclick="toggle_comments('{{question.number|removedots}}'); return false;"><i class="{% if qdict.comment %} icon-comment {% else %} icon-comment-alt {% endif %}">&nbsp;</i></a>
                            </span>
                            <span class="pull-right answered hide" id="answered_{{ question.number|removedots }}">
                                <i class="icon-check green">&nbsp;</i>
                            </span>

                {% endif %}

                        <div class="question type_{{ qdict.qtype }} {% if error %} error prepend-top{% endif %}{{ qdict.qnum_class }}{{ qdict.qalpha_class }} {{qdict.depon_class}}" id="qc_{{ question.number }}" {{qdict.checkstring|safe}} >
                            {% if question.text|geths == 'h1' %}
                                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_{{ k.sortid }}" href="#div_{{ iteratorQ.value }}">
                            {% endif %}
                            {% if qdict.custom %}
                                {% if error %}
                                    <div class="error">
                                        {{ error }}
                                    </div>
                                {% endif %}
                                {% include qdict.template %}


                            {% else %}
                                <div class="question-text {% if qdict.required %}required{% endif %} {% if error %}text-error{% endif %} qtext_{{question.text|geths}}">
                                    <span class="qnumber_{{question.text|geths}}">{{ question.display_number }}.</span>
                                    <span class="qtext">{{ question.text|removehs|safe }}
                                    {% if question.help_text %}
                                    <div class="question-help-text" style="display: none;">
                                        <span>{{ question.help_text|safe }}</span>
                                    </div>

                                {% endif %}
                                   </span>
                                {% if question.text|geths != 'h1' %}
                                    {% if request.user.is_staff %}
                                    <span class="pull-right">
                                        <a href="admin/questionnaire/question/{{ question.id }}/">
                                            <i class="icon-pencil">&nbsp;</i>
                                        </a>
                                    </span>
                                    {% endif %}
                                    <span class="pull-right">
                                        <a href="#" onclick="toggle_comments('{{question.number|removedots}}'); return false;"><i class="{% if qdict.comment %} icon-comment {% else %} icon-comment-alt {% endif %}">&nbsp;</i></a>
                                    </span>
                                    <span class="pull-right answered hide" id="answered_{{ question.number|removedots }}">
                                        <i class="icon-check green">&nbsp;</i>
                                    </span>
                                {% endif %}
                                </div>
                                {% if question.text|geths == 'h1' %}

                                    </a>
                            </div>
                                    <div id="div_{{ iteratorQ.value }}" class="accordion-body in collapse">
                                        <div class="accordion-inner">
                                 {% endif %}
                                <div class="answer qtext_{{question.text|geths}}" id="answer_{{ question.number }}">
                                    {% if error %}
                                        <div class="alert-message block-message text-error input">{{ error }}</div>
                                    {% endif %}
                                    {% include qdict.template %}
                                    <div id="comments_{{question.number|removedots}}" style="display:none;margin-left:40px;">
                                     <a href="#" class="span6" onclick="toggle_comments('{{question.number|removedots}}'); return false;"><i class="icon-comment">&nbsp;</i> Comments</a>
                                    <textarea style=" background-color:#EEE;color: #000;" class="span6" name="comment_question_{{ question.number }}" cols="50" rows="5">{{qdict.comment}}</textarea>
                                    </div>
                                </div>
                            {% endif %}

                        {% if question.footer %}
                            <div class="question-footer">
                                {{ question.footer|textile }}
                                <div class="clearfix"></div>
                            </div>
                        {% endif %}

                        </div> <!-- /question container -->

            {% endwith %}

        {% endfor %}

        {% if h1_last.value == '1' %}
                </div>
                </div>
            </div>

        {% endif %}

        </div>  <!-- div accordion2 -->


        <!--{% if k.sortid != 99 and k.sortid != 0%}-->
            <!--<span>* Required</span>-->
        <!--{% endif  %}-->

        <div class="well questionset-submit">
            <!-- Previous | Next buttons -->
            <div class="span5 text-center">
            <!-- If Questionset is not the first (Introduction) or the final (Thank you) -->

                {% if k.prev %}
                    <a href="add/{{ questionset.questionnaire.pk }}/{{ k.prev.sortid }}" class="btn large primary" onclick="questionsets_handle(qs_{{ k.prev.sortid }});  return false;">{% trans "Previous" %}</a>
                {% endif %}
                {% if k.prev and k.next %}

                {% endif %}
                {% if k.next %}
                    <a href="add/{{ questionset.questionnaire.pk }}/{{ k.next.sortid }}" class="btn large primary" onclick="questionsets_handle(qs_{{ k.next.sortid }});  return false;">{% trans "Next" %}</a>
                {% endif %}




                <!-- First Questionset - Introduction -->

            </div>
            <div class="span2 text-right">
                {% if k.sortid != 0 %}
                    <input class="btn large btn-primary" name="submit" type="submit" value="{% trans 'Save' %}" />
                {% endif %}
                {% if k.sortid == 0 %}
                {% endif %}
                    <!-- Last Questionset - Thank You -->
                {% if k.sortid == 99 %}
                    <!--<input class="btn large btn-primary" name="submit" type="submit" value="{% trans 'Save' %}" />-->
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    </form>

</div>

<!-- Fix later -->
<script src="static/js/vendor/bootstrap-tooltip.js"></script>
<script src="static/js/vendor/bootstrap-popover.js"></script>
<script src="static/js/fingerprint.js"></script>

<script type="text/javascript">
    {% block scriptextra %}

function toggle_comments(question_number)
{
    console.log("q + "+ question_number);
    $("#comments_"+question_number).toggle();
}

var database_name = null;

$(document).ready(function(){

    $(".open-button_validator").each(function(i, v) {        
        if(database_name == null){
            var question_number = $(v).attr("id").replace("open-button_validator_", "question_")
            question_number = question_number.replace(".","\\.");
            
            database_name = $('#'+question_number).val();
        }
    });

    $("#qform").submit(function(evnt){
        validateForm(evnt);
    });

});

function validateForm(evnt){
    $(".open-button_validator").each(function(i, v) {        
        if( !validate( $(v).attr("id").replace("open-button_validator_", "question_"))){
            evnt.preventDefault();     
            //console.log("DefaultPrevented");
        }
    });
}

function draw_validator(validator, validated, feedback_message){
    if (validated)
    {
        validator.removeClass("error");
        validator.addClass("success");
        $("span", validator).text(feedback_message);
    } else {        
        validator.removeClass("success");
        validator.addClass("error");
        $("span", validator).text(feedback_message);
    }
}

function validate(question_number)
{
    question_number = question_number + "";
    question_number = question_number.replace(".","\\.");
    var text = $('#'+question_number).val();
    
    //getValidator
    var validator = $('#open-button_validator_'+question_number.replace("question_",""));
    var feedback_message;          
    var validated = false;

    if(text.length == 0){
        draw_validator(validator, false , "Database name must not be empty");
        return false
    }
    
    if(text == database_name){
        draw_validator(validator, true , "");       
        return true;
    }
    //console.log($('#'+question_number).val());

    $.ajax({
        type: 'GET',
        url: 'api/validate?name='+text,
        dataType: 'json',
        success: function(data) {
              //console.log(data['contains'])
              
              if (data['contains'] == false)
              {
                validated = true;
                draw_validator(validator, validated, "Database Name Available.");
              }else{
                validated = false;
                draw_validator(validator, validated, "Database Name already exists.");
              }     
            },
        data: {},
        async: false
    });

    return validated;
};

    help_text_popover();

    {% for k, qlist in questions_list %}
        {% if k.sortid != 0 and k.sortid != 99 %}
    $("#collapseall_qs_{{ k.sortid }}").bind('click', function (e) {
//        console.log('Collapse all');
        e.preventDefault();
        e.stopPropagation();

       var div_id = 'accordion_{{ k.sortid }}';
       collapseAll($("#collapseall_qs_{{ k.sortid }}"), div_id);

       });

        {% endif %}
        {% endfor %}

    function collapseAll(element, div_id){
        if (element.text().indexOf('Collapse') !== -1) {
           console.log('Collapse all');
           element.text('Expand all');
           if (!element.hasClass('disabled')){
            element.parents().find('#'+div_id +' .collapse').each(function(index){
                //$(this).addClass('in');
                $(this).collapse('hide');
            });
           }
       } else {
           console.log('Expand all');
            element.text('Collapse all');
           if (!element.hasClass('disabled')){
            element.parents().find('#'+div_id +' .collapse').each(function(index){
                //$(this).removeClass('in');
                $(this).collapse('show');
            });
           }
       }
    };

{% endblock %}
</script>